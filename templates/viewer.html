<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Flair Viewer</title>
    <link href='//fonts.googleapis.com/css?family=Raleway' rel='stylesheet'>

    <script type="text/javascript" src="//code.jquery.com/jquery-2.1.3.min.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>
    <script src="static/three.min.js"></script>
    <script type="text/javascript" charset="utf-8">
        var connected = false;
        var id;

        function init() {
            if (connected) return;

            var socket = io.connect();

            socket.on('connect', function() {
                if (connected) return;

                console.log("connected");
                id = parseInt(document.getElementById("id").value)
                socket.emit('initDisplay', id);
            });

            socket.on('notfound', function() {
                $('#messagedisplay').text("Controller not found");
            });
            socket.on('success', function() {
                $('#messagedisplay').text("Connection successful");
                connected = true;
                document.getElementById("codeentry").style.visibility = "hidden";
                socket.on('data', function(data) {
                  addPoint(data.x,data.y,data.z);
                });

                var scene, camera, renderer;

                var container, HEIGHT,
                    WIDTH, fieldOfView, aspectRatio,
                    nearPlane, farPlane, stats,
                    geometry, particleCount,
                    i, h, color, size,
                    materials = [],
                    mouseX = 0,
                    mouseY = 0,
                    windowHalfX, windowHalfY, cameraZ,
                    fogHex, fogDensity, parameters = {},
                    parameterCount, particles;

                initRender();
                animate();

                function addPoint(x,y,z) {
                    var vertex = new THREE.Vector3();
                    vertex.x=-y * 500;
                    vertex.y=x * 500;
                    vertex.z=z * 500;

                    geometry = new THREE.Geometry();
                    geometry.vertices.push(vertex);
                    scene.add(new THREE.Points(geometry, materials[0]));
                }

                function initRender() {

                    HEIGHT = window.innerHeight;
                    WIDTH = window.innerWidth;
                    windowHalfX = WIDTH / 2;
                    windowHalfY = HEIGHT / 2;

                    fieldOfView = 75;
                    aspectRatio = WIDTH / HEIGHT;
                    nearPlane = 1;
                    farPlane = 3000;

                    cameraZ = farPlane / 3;
                    fogHex = 0x000000;
                    fogDensity = 0.0007;

                    camera = new THREE.PerspectiveCamera(fieldOfView, aspectRatio, nearPlane, farPlane);
                    camera.position.set(0,300,0);

                    scene = new THREE.Scene();
                    scene.fog = new THREE.FogExp2(fogHex, fogDensity);

                    container = document.createElement('div');
                    document.body.appendChild(container);
                    document.body.style.margin = 0;
                    document.body.style.overflow = 'hidden';

                    parameters = [
                        [
                            [1, 1, 0.5], 5
                        ],
                        [
                            [0.95, 1, 0.5], 4
                        ],
                        [
                            [0.90, 1, 0.5], 3
                        ],
                        [
                            [0.85, 1, 0.5], 2
                        ],
                        [
                            [0.80, 1, 0.5], 1
                        ]
                    ];
                    parameterCount = parameters.length;



                    for (i = 0; i < parameterCount; i++) {

                        color = parameters[i][0];
                        size = parameters[i][1];

                        materials[i] = new THREE.PointsMaterial({
                            size: size
                        });

                    }

                    renderer = new THREE.WebGLRenderer();
                    renderer.setPixelRatio(window.devicePixelRatio);
                    renderer.setSize(WIDTH, HEIGHT);

                    container.appendChild(renderer.domElement);

                    window.addEventListener('resize', onWindowResize, false);
                    document.addEventListener('mousemove', onDocumentMouseMove, false);
                    document.addEventListener('touchstart', onDocumentTouchStart, false);
                    document.addEventListener('touchmove', onDocumentTouchMove, false);

                    camera.lookAt(scene.position);


                }

                function animate() {
                    requestAnimationFrame(animate);
                    render();
                }

                function render() {
                    var time = Date.now() * 0.00005;


                    for (i = 0; i < materials.length; i++) {

                        color = parameters[i][0];

                        h = (360 * (color[0] + time) % 360) / 360;
                        materials[i].color.setHSL(h, color[1], color[2]);
                    }

                    renderer.render(scene, camera);
                }

                function onDocumentMouseMove(e) {
                    mouseX = e.clientX - windowHalfX;
                    mouseY = e.clientY - windowHalfY;
                }

                /*	Mobile users?  I got your back homey	*/

                function onDocumentTouchStart(e) {

                    if (e.touches.length === 1) {

                        e.preventDefault();
                        mouseX = e.touches[0].pageX - windowHalfX;
                        mouseY = e.touches[0].pageY - windowHalfY;
                    }
                }

                function onDocumentTouchMove(e) {

                    if (e.touches.length === 1) {

                        e.preventDefault();
                        mouseX = e.touches[0].pageX - windowHalfX;
                        mouseY = e.touches[0].pageY - windowHalfY;
                    }
                }

                function onWindowResize() {

                    windowHalfX = window.innerWidth / 2;
                    windowHalfY = window.innerHeight / 2;

                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                }

            });


        }
    </script>
    <link href='/static/style.css' rel='stylesheet'>

</head>

<body>
    <div class="container" id="codeentry">

        <label for="code">Enter the code displayed on your mobile device:</label>
        <p><span id="messagedisplay"></span></p>
        <input id="id" type="text" class="form-control input-lg">

        <br>

        <button id="button" onclick="init()" style="width:100%;" class="btn btn-success">Start Drawing!</button>

    </div>
</body>

</html>
